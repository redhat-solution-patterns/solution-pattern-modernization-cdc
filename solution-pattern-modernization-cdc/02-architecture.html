<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Solution Pattern: Using Change Data Capture for Stack Modernization :: Solution Patterns for Cloud Native Architectures</title>
    <link rel="canonical" href="https://redhat-solution-patterns.github.io/solution-pattern-modernization-cdc/solution-pattern-modernization-cdc/02-architecture.html">
    <link rel="prev" href="index.html#_content_overview">
    <link rel="next" href="03-demo.html">
    <meta name="generator" content="Antora 3.0.0">
<link rel="stylesheet" href="../_/css/site.css">
<link rel="stylesheet" href="../_/css/extra.css">
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EFPESFY3D2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-EFPESFY3D2');
</script>  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://redhat.com" target="_blank"><img
          src="../_/img/logo.png" height="40px" alt="Cloud Native Architecture Solution Patterns"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-solution-patterns.github.io/solution-pattern-modernization-cdc">Solution Patterns for Cloud Native Architectures</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">

       
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Solution Patterns</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Adopt Change Data Capture for <br/>stack modernization</a>
            <a class="navbar-item" href="#">Edge-to-Cloud Pipelines</a>     <a class="navbar-item" href="#">Event driven architecture</a>
          </div>
        </div>

        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Other</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-gitops-patterns.io/">GitOps Solution Patterns</a>
            <a class="navbar-item" href="https://hybrid-cloud-patterns.io/">Hybrid Cloud Solution Patterns</a>
          </div>
        </div>

        <a class="navbar-item" target="_blank" href="https://www.redhat.com/en/products/middleware">Red Hat Application Services</a>

        <a class="navbar-item" target="_blank" href="https://developers.redhat.com/middleware">Learn more</a>

      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="solution-pattern-modernization-cdc" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Modernize your stack by adopting Change Data Capture</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">1. Home page</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#use-cases">1.1 Use cases</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_content_overview">1.2 Content Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-pattern.html#_story">1.3 The story behind this solution pattern</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-pattern.html#_solution">1.4 The solution</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_content_overview">1.5 Explore more solution patterns</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-architecture.html">2. Architecture</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#challenges">2.1. Common challenges</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#tech_stack">2.2. Technology stack</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#in_depth">2.3. An in-depth look at the solution&#8217;s architecture</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#scenario-cashback-wallet">2.3.1 Scenario: Cashback Wallet</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#scenario-search">2.3.2 Scenario: Full-text search for data in legacy database</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-demo.html">3. See the Solution in Action</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-demo.html#demo_desc">3.1. Demonstration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-demo.html#run_demo">3.2. Run this demonstration</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03-demo.html#pre_reqs_demo">3.3. Before getting started</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03-demo.html#install_demo">3.4. Installing the demo</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03-demo.html#walthrough_demo">3.5. Walkthrough guide</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="https://redhat-solution-patterns.github.io/">4. Other Red Hat Solution Patterns</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Modernize your stack by adopting Change Data Capture</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Modernize your stack by adopting Change Data Capture</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Modernize your stack by adopting Change Data Capture</a></li>
    <li><a href="02-architecture.html">2. Architecture</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-solution-patterns/solution-pattern-modernization-cdc/edit/master/documentation/modules/ROOT/pages/02-architecture.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Solution Pattern: Using Change Data Capture for Stack Modernization</h1>
<h1 id="_architecture" class="sect0"><a class="anchor" href="#_architecture"></a><a class="link" href="#_architecture">Architecture</a></h1>
<div class="openblock partintro">
<div class="content">
Introduction for the architecture of this solution pattern.
</div>
</div>
<div class="sect1">
<h2 id="_common_challenges_when_extending_stack_capabilities"><a class="anchor" href="#_common_challenges_when_extending_stack_capabilities"></a><a class="link" href="#_common_challenges_when_extending_stack_capabilities">1. Common Challenges when Extending Stack Capabilities</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>To better explain and detail the reasons for the existence of this solution pattern we&#8217;ll picture some common needs and challenges amongst organizations that already have production systems and seeks innovation and modernization.</p>
</div>
<div class="sect2">
<h3 id="_distributed_systems_and_data_access"><a class="anchor" href="#_distributed_systems_and_data_access"></a><a class="link" href="#_distributed_systems_and_data_access">1.1. Distributed Systems and Data Access</a></h3>
<div class="paragraph">
<p>In a distributed system it&#8217;s common to have services that must use data owned by other services to deliver its capabilities.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><strong>First challenge</strong></p>
</div>
<div class="paragraph">
<p>Currently, there is a production legacy <strong>retail service</strong> that persists all sales and inventory data in a single database. The challenge is now to deliver a <strong>cashback</strong> capability that is highly dependent on the retail data, leveraging modern technology and architecture design best practices.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>At a first glance, a simple solution to such complex problem would be to implement the cashback service with its own database for cashback domain data, and directly accessing retail database to obtain and update sales information.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/01/incorrect-db-access.png" alt="incorrect db access" width="75%">
</div>
</div>
<div class="paragraph">
<p>Unfortunately, this is an anti-pattern for data access and management in a distributed architecture. Multiple services should not consume and change data directly in databases owned by other services.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_need_to_store_data_in_multiple_data_stores"><a class="anchor" href="#_the_need_to_store_data_in_multiple_data_stores"></a><a class="link" href="#_the_need_to_store_data_in_multiple_data_stores">1.2. The need to store data in multiple data stores</a></h3>
<div class="paragraph">
<p>Another modernization challenge is enhancing search capabilities in huge set of data, improving efficiency by increasing search response time, reducing number of disk accesses, using efficient search algorithms and being able to scale according to demand. To address such problem, we could complement the retail service by adding a search index like <a href="https://www.elastic.co/">Elasticsearch</a>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><strong>Second challenge</strong></p>
</div>
<div class="paragraph">
<p>In other to start consuming search capabilities from tools like Elasticsearch, the first step is to feed data into the tool&#8217;s index. This process is called <code>indexing</code>. All the queryable data needs to be pushed to the tool&#8217;s storage, the index (Apache Lucene).</p>
</div>
<div class="paragraph">
<p>The production stack is based on the <strong>retail service</strong> that currently persists data to a single database. The challenge is to make all the retail data searchable through a tool like Elasticsearch.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>One could think about changing the service to push the data not only to its own database, but also to elasticsearch. It becomes a distributed system where the core data operations are no longer handled in single transactions. Be aware: this is yet another anti-pattern, called <a href="https://developers.redhat.com/articles/2021/07/30/avoiding-dual-writes-event-driven-applications">dual write</a>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<a href="https://developers.redhat.com/articles/2021/07/30/avoiding-dual-writes-event-driven-applications">Dual writes</a> can cause data inconsistency problems for distributed systems.
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/01/incorrect-dual-write.png" alt="incorrect dual write" width="75%">
</div>
</div>
<div class="paragraph">
<p>The consequence of issues in this solution would be to have an outdated data being queried by the user, in other words, a user could potentially see an item for sale that is no longer available, or see a list of items with an outdated price.</p>
</div>
<div class="paragraph">
<p>Other than data inconsistency, changes to the legacy application would be required. Such changes are not always possible either for business or technological restrictions.</p>
</div>
<div class="sect3 anti-patterns">
<h4 id="_avoid_antipatterns"><a class="anchor" href="#_avoid_antipatterns"></a><a class="link" href="#_avoid_antipatterns">1.2.1. Avoid Antipatterns</a></h4>
<div class="paragraph">
<p>Think twice before delivering solutions with antipatterns. Here&#8217;s a summary of the two antipatterns we&#8217;ve seen so far:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Shared databases</dt>
<dd>
<p>Multiple services are linked through a single database.</p>
</dd>
<dt class="hdlist1">Dual write</dt>
<dd>
<p>A situation when a service inserts and/or changes data in two or more different data stores or systems. (e.g. database and search index or a distributed cache).</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tech_stack"><a class="anchor" href="#tech_stack"></a><a class="link" href="#tech_stack">2. Technology Stack</a></h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://www.redhat.com/en/technologies/cloud-computing/openshift">Red Hat OpenShift</a></p>
</li>
<li>
<p>Red Hat Application Foundation</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://access.redhat.com/products/quarkus">Quarkus</a></p>
</li>
<li>
<p><a href="https://www.redhat.com/en/technologies/jboss-middleware/fuse">Camel (a.k.a. Red Hat Fuse)</a></p>
</li>
<li>
<p><a href="https://developers.redhat.com/articles/2021/12/06/improve-your-kafka-connect-builds-debezium">Debezium and Kafka connect</a></p>
</li>
<li>
<p><a href="https://www.redhat.com/en/technologies/cloud-computing/openshift/openshift-streams-for-apache-kafka">Kafka (a.k.a. Red Hat AMQ Streams</a></p>
</li>
<li>
<p><a href="https://www.redhat.com/en/technologies/cloud-computing/openshift/openshift-streams-for-apache-kafka">Kafka Streams</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Other:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.elastic.co/">ElasticSearch</a></p>
</li>
<li>
<p><a href="https://www.postgresql.org/">PostgreSQL database</a></p>
</li>
<li>
<p><a href="https://helm.sh/">Helm</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="in_depth"><a class="anchor" href="#in_depth"></a><a class="link" href="#in_depth">3. An in-depth look at the solution&#8217;s architecture</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The whole solution builds upon the event streams flowing for each change on the database. The data integration is the enabler for all the new services to execute their respective operations.</p>
</div>
<div class="paragraph">
<p>The following <a href="https://c4model.com">diagram</a> represents an abstract architectural view of the system scope, personas involved, the multiple apps and storage:</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="_images/02/architectural-overview.png" target="_blank" rel="noopener"><img src="_images/02/architectural-overview.png" alt="architectural overview" width="100%"></a>
</div>
<div class="title">Figure 1. Architecture Diagram: System Context. An abstract representation of the whole solution.</div>
</div>
<div class="paragraph">
<p>Three main application contexts are part of this architecture. The <strong>retail application</strong> represents the legacy application. The <strong>cashback application</strong> and the <strong>search application</strong>, represent the two new use cases to be addressed without impacting the existing service.</p>
</div>
<div class="paragraph">
<p>The two base scenarios targeted are, first, the event-driven processing of cashback for every customer purchase according to his/her customer status, and second, allowing the usage of full-text search capabilities for data that is still maintained via legacy application.</p>
</div>
<div class="sect2">
<h3 id="scenario-cashback-wallet"><a class="anchor" href="#scenario-cashback-wallet"></a><a class="link" href="#scenario-cashback-wallet">3.1. Scenario: Cashback Wallet</a></h3>
<div class="paragraph">
<p>a) <strong>Cashback Wallet:</strong> A new microservice implements new capabilities enabled by data integration. This integration happens via database event streaming and processing from legacy database to the new cashback database.</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="_images/02/arch-cashback-overview.png" target="_blank" rel="noopener"><img src="_images/02/arch-cashback-overview.png" alt="arch cashback overview" width="100%"></a>
</div>
<div class="title">Figure 2. Architecture Diagram: Cashback Wallet Context. A representation of the solution for cashback functionality.</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The cashback processing kicks-off when a new purchase is registered via legacy application. In the demonstration implemented for this solution pattern, we use a service to simulate purchases and register them in the database.</p>
</li>
<li>
<p>Debezium will capture all changes in the database tables below;</p>
<div class="ulist">
<ul>
<li>
<p>List of tracked tables in retail database: <code>public.customer</code>,<code>public.sale</code>,<code>public.line_item</code>,<code>public.product</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Next, <a href="https://debezium.io">Debezium</a> streams the data them over to Kafka. The event streaming solution can be hosted on-premise or on the cloud. In this implementation, we are using <a href="https://red.ht/TryKafka">Red Hat Managed OpenShift Streams for Apache Kafka</a>.</p>
</li>
<li>
<p>An integration microservice, <code>sales-streams</code>, reacts to events captured by Debezium and published on three topics, respective to <code>sale-change-event</code> and <code>lineitem-change-event</code>.</p>
</li>
<li>
<p>Using <a href="https://quarkus.io/guides/kafka-streams">Kafka Streams</a>, the service aggregates multiple events that correlates to a unique purchase. The service will calculate the total amount of the purchase based on individual items price captured, and will publish the enriched data to the topic <code>sales-aggregated</code>.</p>
</li>
<li>
<p>Another event-driven microservice is responsible for tracking customer&#8217;s change streamed by Debezium, and for reacting to new enriched sales information - in other words, reacting to data processed by the <code>sales-stream</code> application.</p>
</li>
<li>
<p>The service synchronizes <code>customers</code> and <code>expenses</code> in the cashback database. This database used to store new cashback feature-related data.</p>
</li>
<li>
<p>Once the <code>cashback-connector</code> microservice finished its operations, it will notify the ecosystem that a new or updated expense is available - especially for cashback-processing. A new event is published to an <code>expense-events</code> topic so that interested (subscribed) services can act if needed.</p>
</li>
<li>
<p>Now that every information is synchronized in the cashback database, the system can calculate and update any incoming cashback amount the customer earned when purchasing products. The choreography goes on as the <code>cashback-service</code> jumps in and reacts to the <code>expense-events</code> topic.</p>
<div class="ulist">
<ul>
<li>
<p>This microservice is reponsible for the calculation of the cashback based on a customer status, and for making sure the customer will earn a percentual relative to each expense amount. Every customer owns a <strong>Cashback Wallet</strong>, in other words, all incoming cashback can be accumulated and used later. Since this service is responsible for integrating services in a cloud environment, the  technologies used in the demo implementation are <a href="https://quarkus.io/guides/camel">Camel, with Quarkus as the runtime</a>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>With the values properly calculated, the <code>cashback-service</code> persists cashback-related information, including new cashback wallets for first-time customers, incoming cashback for each single customer&#8217;s expense, and total cashback.</p>
</li>
<li>
<p>The user can visualize cashback data using a sample application <code>cashback-ui</code>, which runs with Quarkus and uses Panache Rest to handle persistence and expose REST endpoints. Information is finally displayed through an angular-based page. This application is used in the demo to help developers visualizing the demonstration results.</p>
<div class="imageblock">
<div class="content">
<a class="image" href="_images/02/cashback-ui.png" target="_blank" rel="noopener"><img src="_images/02/cashback-ui.png" alt="cashback ui" width="100%"></a>
</div>
<div class="title">Figure 3. Cashback Wallet UI: sample demo ui for easier data visualization when trying the solution pattern implementation.</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="scenario-search"><a class="anchor" href="#scenario-search"></a><a class="link" href="#scenario-search">3.2. Scenario: Full-text search for data in legacy database</a></h3>
<div class="paragraph">
<p>b) <strong>Full-text search of legacy data:</strong> enables full-text search for legacy data by adopting data integration through event streaming and processing. All changes to the legacy database tracked tables, including the operations create, updated and delete, should be reflected in the search index tool. The indexing tool will then store and index data in a way that supports fast searches.</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="_images/02/arch-search-overview.png" target="_blank" rel="noopener"><img src="_images/02/arch-search-overview.png" alt="arch search overview" width="100%"></a>
</div>
<div class="title">Figure 4. Architecture Diagram: Search Solution Context. A representation of the solution for the new search functionality.</div>
</div>
<div class="paragraph">
<p>Similarly to the behavior of the cashback scenario, here Debezium is tracking changes in the retail database. All changes to product data is streamed to Kafka. The <code>elastic-connector</code> service reacts to product events and synchronizes it within ElasticSearch product index.</p>
</div>
<div class="paragraph">
<p>For demonstration purposes, the <code>search-service</code> holds a sample UI to allow searching data in the indexing tool.</p>
</div>
<div class="paragraph">
<p>The following services are part of this scenario:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Retail database</strong>: stores all information from the legacy application. It includes information about <strong>products</strong>, <strong>customers</strong> and new <strong>sales</strong> (detailed through <strong>line items</strong>).The tables in this database are tracked by Debezium.</p>
</li>
<li>
<p><strong>Debezium</strong>: tracks all events that happens in tables from retail db (public.customer,public.sale,public.line_item,public.product) and streams changes into Kafka streams;</p>
</li>
<li>
<p><strong>Elastic connector service</strong>: an event-driven microservice that reacts to products' events and push relevant updates to Elastic. This service capabilities were developed with with Camel and Quarkus.</p>
</li>
<li>
<p><strong>Search service</strong>: a sample quarkus service that integrates with ElasticSearch using the <a href="https://quarkus.io/guides/elasticsearch">quarkus elastic-rest-client extension</a>, and exposes a REST endpoint for searching products by name and description. For demonstration purposes, this service has a page to facilitate visualizing the search results.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="_images/02/search-ui.png" target="_blank" rel="noopener"><img src="_images/02/search-ui.png" alt="search ui" width="100%"></a>
</div>
<div class="title">Figure 5. Seach Service: a Quarkus client that integrates with Elastic for easier search results visualization.</div>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="index.html#_content_overview" class="query-params-link">1.5 Explore more solution patterns</a></span>
  <span class="next"><a href="03-demo.html" class="query-params-link">3. See the Solution in Action</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <img
          src="../_/img/app-services-logo.png" height="40px" alt="Cloud Native Architecture Solution Patterns"  href="https://redhat.com" ></a>
</footer><script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
